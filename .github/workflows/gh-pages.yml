name: Build and deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Ensure dist/index.html
        run: |
          if [ ! -f ./dist/index.html ]; then
            cat > ./dist/index.html <<'HTML'
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ChatWidget Demo</title>
  </head>
  <body>
    <div id="soulvex-chat"></div>
    <script src="./bundle.js"></script>
    <script>
      if (window.SoulvexChatWidget && typeof SoulvexChatWidget.mount === 'function') {
        SoulvexChatWidget.mount({ target: '#soulvex-chat' });
      } else if (window.MyComponent && typeof window.MyComponent.default?.mount === 'function') {
        window.MyComponent.default.mount({ target: '#soulvex-chat' });
      } else if (window.MyComponent && typeof window.MyComponent.mount === 'function') {
        window.MyComponent.mount({ target: '#soulvex-chat' });
      } else {
        console.warn('Chat widget mount function not found on window.');
      }
    </script>
  </body>
</html>
HTML
          fi
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
